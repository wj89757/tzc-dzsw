"use strict";function replacePos(a,b,c){return a.substr(0,b-1)+c+a.substring(b,a.length)}$(function(){$("#search_button").button({icons:{primary:"ui-icon-search"}}),$("#question_button").button({icons:{primary:"ui-icon-lightbulb"}}).click(function(){$.cookie("user")?$("#question").dialog("open"):($("#error").dialog("open"),setTimeout(function(){$("#error").dialog("close"),$("#login").dialog("open")},1e3))}),$.ajax({url:"show_content.php",type:"POST",success:function(a){var d=$.parseJSON(a),e="",f=[],g=[];$.each(d,function(a,b){e+="<h4>"+b.user+" 发表于 "+b.date+"</h4><h3>"+b.title+'</h3><div class="editor">'+b.content+'</div><div class="bottom"><span class="comment" data-id="'+b.id+'">'+b.count+'条评论</span> <span class="up">收起</span></div><hr noshade="noshade" size="1" /><div class="comment_list"></div>'}),$(".content").append(e),$.each($(".editor"),function(a,b){f[a]=$(b).html(),g[a]=f[a].substr(0,200),"<"==g[a].substring(199,200)&&(g[a]=replacePos(g[a],200,"")),"</"==g[a].substring(198,200)&&(g[a]=replacePos(g[a],199,"")),f[a].length>200&&(g[a]+='...<span class="down">显示全部</span>',$(b).html(g[a])),$(".bottom .up").hide()}),$.each($(".editor"),function(a){$(this).on("click",".down",function(){$(".editor").eq(a).html(f[a]),$(this).hide(),$(".bottom .up").eq(a).show()})}),$.each($(".bottom"),function(a){$(this).on("click",".up",function(){$(".editor").eq(a).html(g[a]),$(this).hide(),$(".editor .down").eq(a).show()})}),$.each($(".bottom"),function(a){$(this).on("click",".comment",function(){var b=this;$.cookie("user")?($(".comment_list").eq(a).has("form").length||$.ajax({url:"show_comment.php",type:"POST",data:{titleid:$(b).attr("data-id")},beforeSend:function(){$(".comment_list").eq(a).append('<dl class="comment_load"><dd>正在加载评论</dd></dl>')},success:function(c){var e,f,g;$(".comment_list").eq(a).find(".comment_load").hide(),e=$.parseJSON(c),f=0,$.each(e,function(b,c){f=c.count,$(".comment_list").eq(a).append('<dl class="comment_content"><dt>'+c.user+"</dt><dd>"+c.comment+'</dd><dd class="date">'+c.date+"</dd></dl>")}),$(".comment_list").eq(a).append('<dl><dd><span class="load_more">加载更多评论</span></dd></dl>'),g=2,g>f&&($(".comment_list").eq(a).find(".load_more").off("click"),$(".comment_list").eq(a).find(".load_more").hide()),$(".comment_list").eq(a).find(".load_more").button().on("click",function(){$(".comment_list").eq(a).find(".load_more").button("disable"),$.ajax({url:"show_comment.php",type:"POST",data:{titleid:$(b).attr("data-id"),page:g},beforeSend:function(){$(".comment_list").eq(a).find(".load_more").html('<img src="img/more_load.gif" />')},success:function(b){var d=$.parseJSON(b);$.each(d,function(b,c){$(".comment_list").eq(a).find(".comment_content").last().after('<dl class="comment_content"><dt>'+c.user+"</dt><dd>"+c.comment+'</dd><dd class="date">'+c.date+"</dd></dl>")}),$(".comment_list").eq(a).find(".load_more").button("enable"),$(".comment_list").eq(a).find(".load_more").html("加载更多评论"),g++,g>f&&($(".comment_list").eq(a).find(".load_more").off("click"),$(".comment_list").eq(a).find(".load_more").hide())}})}),$(".comment_list").eq(a).append('<form><dl class="comment_add"><dt><textarea name="comment"></textarea></dt><dd><input type="hidden" name="titleid" value="'+$(b).attr("data-id")+'" /><input type="hidden" name="user" value="'+$.cookie("user")+'" /><input type="button" value="发表" /></dd></dl></form>'),$(".comment_list").eq(a).find("input[type=button]").button().click(function(){var b=this;$(".comment_list").eq(a).find("form").ajaxSubmit({url:"add_comment.php",type:"POST",beforeSubmit:function(){$("#loading").dialog("open"),$(b).button("disable")},success:function(c){c&&($(b).button("enable"),$("#loading").css("background","url(img/success.gif) no-repeat 20px center").html("数据新增成功..."),setTimeout(function(){var b=new Date;$("#loading").dialog("close"),$(".comment_list").eq(a).prepend('<dl class="comment_content"><dt>'+$.cookie("user")+"</dt><dd>"+$(".comment_list").eq(a).find("textarea").val()+"</dd><dd>"+b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()+" "+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()+"</dd></dl>"),$(".comment_list").eq(a).find("form").resetForm(),$("#loading").css("background","url(img/loading.gif) no-repeat 20px center").html("数据交互中...")},1e3))}})})}}),$(".comment_list").eq(a).is(":hidden")?$(".comment_list").eq(a).show():$(".comment_list").eq(a).hide()):($("#error").dialog("open"),setTimeout(function(){$("#error").dialog("close"),$("#login").dialog("open")},1e3))})})}}),$("#question").dialog({autoOpen:!1,modal:!0,title:"提问",width:500,height:360,resizable:!1,buttons:{"发布":function(){$(this).ajaxSubmit({url:"add_content.php",type:"POST",data:{user:$.cookie("user"),content:$(".uEditorIframe").contents().find("#iframeBody").html()},beforeSubmit:function(){$("#loading").dialog("open"),$("#question").dialog("widget").find("button").eq(1).button("disable")},success:function(a){a&&($("#question").dialog("widget").find("button").eq(1).button("enable"),$("#loading").css("background","url(img/success.gif) no-repeat 20px center").html("数据新增成功..."),setTimeout(function(){$("#loading").dialog("close"),$("#question").dialog("close"),$("#question").resetForm(),$(".uEditorIframe").contents().find("#iframeBody").html("请输入问题描述！"),$("#loading").css("background","url(img/loading.gif) no-repeat 20px center").html("数据交互中...")},1e3))}})}},show:!0,hide:!0,closeText:"关闭"}),$(".uEditorCustom").uEditor(),$("#error").dialog({autoOpen:!1,modal:!0,closeOnEscape:!1,resizable:!1,draggable:!1,width:180,height:50}).parent().find(".ui-widget-header").hide(),$("#reg_a").click(function(){$("#reg").dialog("open")}),$("#member,#logout").hide(),$.cookie("user")?($("#member,#logout").show(),$("#reg_a,#login_a").hide(),$("#member").html($.cookie("user"))):($("#member,#logout").hide(),$("#reg_a,#login_a").show()),$("#logout").click(function(){$.removeCookie("user"),window.location.href="/jQueryProject"}),$("#loading").dialog({autoOpen:!1,modal:!0,closeOnEscape:!1,resizable:!1,draggable:!1,width:180,height:50}).parent().find(".ui-widget-header").hide(),$("#reg").dialog({autoOpen:!1,modal:!0,title:"知问前端用户注册",width:320,height:340,resizable:!1,buttons:{"提交":function(){$(this).submit()},"取消":function(){$(this).dialog("close")}},show:!0,hide:!0,closeText:"关闭"}).buttonset().validate({submitHandler:function(a){$(a).ajaxSubmit({url:"add.php",type:"POST",beforeSubmit:function(){$("#loading").dialog("open"),$("#reg").dialog("widget").find("button").eq(1).button("disable")},success:function(a){a&&($("#reg").dialog("widget").find("button").eq(1).button("enable"),$("#loading").css("background","url(img/success.gif) no-repeat 20px center").html("数据新增成功..."),$.cookie("user",$("#user").val()),setTimeout(function(){$("#loading").dialog("close"),$("#reg").dialog("close"),$("#reg").resetForm(),$("#reg span.star").html("*").removeClass("succ"),$("#loading").css("background","url(img/loading.gif) no-repeat 20px center").html("数据交互中..."),$("#member,#logout").show(),$("#reg_a,#login_a").hide(),$("#member").html($.cookie("user"))},1e3))}})},showErrors:function(){var c=this.numberOfInvalids();c>0?$("#reg").dialog("option","height",20*c+340):$("#reg").dialog("option","height",340),this.defaultShowErrors()},highlight:function(a){$(a).css("border","1px solid #630"),$(a).parent().find("span").html("*		").removeClass("succ")},unhighlight:function(a){$(a).css("border","1px solid #ccc"),$(a).parent().find("span").html("&nbsp;").addClass("succ")},errorLabelContainer:"ol.reg_error",wrapper:"li",rules:{user:{required:!0,minlength:2,remote:{url:"is_user.php",type:"POST"}},pass:{required:!0,minlength:6},email:{required:!0,email:!0},date:{date:!0}},messages:{user:{required:"账号不得为空！",minlength:"账号不得小于{0}位！",remote:"账号被占用！"},pass:{required:"密码不得为空！",minlength:"密码不得小于{0}位！"},email:{required:"邮箱不得为空！",email:"请输入正确的邮箱地址！"},date:{required:"日期不得为空！"}}}),$("#date").datepicker({changeMonth:!0,changeYear:!0,yearSuffix:"",maxDate:0,yearRange:"1950:2020"}),$("#email").autocomplete({delay:0,autoFocus:!0,source:function(a,b){var i,j,c=["qq.com","163.com","126.com","263.com","sina.com.cn","gmail.com","foxmail.com","hotmail.com"],d=a.term,e=d,f="",g=d.indexOf("@"),h=[];h.push(d),g>-1&&(e=d.slice(0,g),f=d.slice(g+1)),e&&(i=f?$.grep(c,function(a){return a.indexOf(f)>-1}):c,j=$.map(i,function(a){return e+"@"+a}),h=h.concat(j)),b(h)}}),$("#login_a").click(function(){$("#login").dialog("open")}),$("#login").dialog({autoOpen:!1,modal:!0,title:"知问前端用户登录",width:320,height:240,resizable:!1,buttons:{"登录":function(){$(this).submit()}},show:!0,hide:!0,closeText:"关闭"}).validate({submitHandler:function(a){$(a).ajaxSubmit({url:"login.php",type:"POST",beforeSubmit:function(){$("#loading").dialog("open"),$("#login").dialog("widget").find("button").eq(1).button("disable")},success:function(a){a&&($("#login").dialog("widget").find("button").eq(1).button("enable"),$("#loading").css("background","url(img/success.gif) no-repeat 20px center").html("登录成功..."),$("#expires").is(":checked")?$.cookie("user",$("#login_user").val(),{expires:7}):$.cookie("user",$("#login_user").val()),setTimeout(function(){$("#loading").dialog("close"),$("#login").dialog("close"),$("#login").resetForm(),$("#login span.star").html("*").removeClass("succ"),$("#loading").css("background","url(img/loading.gif) no-repeat 20px center").html("数据交互中..."),$("#member,#logout").show(),$("#reg_a,#login_a").hide(),$("#member").html($.cookie("user"))},1e3))}})},showErrors:function(){var c=this.numberOfInvalids();c>0?$("#login").dialog("option","height",20*c+240):$("#login").dialog("option","height",240),this.defaultShowErrors()},highlight:function(a){$(a).css("border","1px solid #630"),$(a).parent().find("span").html("*").removeClass("succ")},unhighlight:function(a){$(a).css("border","1px solid #ccc"),$(a).parent().find("span").html("&nbsp;").addClass("succ")},errorLabelContainer:"ol.login_error",wrapper:"li",rules:{login_user:{required:!0,minlength:2},login_pass:{required:!0,minlength:6,remote:{url:"login.php",type:"POST",data:{login_user:function(){return $("#login_user").val()}}}}},messages:{login_user:{required:"账号不得为空！",minlength:"账号不得小于{0}位！"},login_pass:{required:"密码不得为空！",minlength:"密码不得小于{0}位！",remote:"账号或密码不正确！"}}}),$("#tabs").tabs({}),$("#accordion").accordion({})});